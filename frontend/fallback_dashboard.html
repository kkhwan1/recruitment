<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruit Guardian - Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js & React-Chartjs-2 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-chartjs-2"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .gradient-text {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body>
    <div id="root">
        <div style="padding: 2rem; text-align: center; color: #94a3b8;">
            Loading interface...<br>
            <small>(If this persists, allow scripts/fetch or check internet)</small>
        </div>
    </div>

    <script type="text/babel">
        // Safe Global Access
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const ReactChartjs2 = window['react-chartjs-2'];
        const Chart = window.Chart;

        // Prevent crash if libs missing
        if (!React || !ReactDOM || !ReactChartjs2 || !Chart) {
            document.getElementById('root').innerHTML = '<div style="color:red; p:2rem">Error: Libraries failed to load from CDN. Check internet connection.</div>';
            throw new Error("Missing libraries");
        }

        const { useState, useEffect } = React;
        const { Doughnut } = ReactChartjs2;

        Chart.register(Chart.ArcElement, Chart.Tooltip, Chart.Legend);

        const API_BASE = 'http://127.0.0.1:8000/api';

        // MOCK DATA (Fallback)
        const MOCK_STATS = {
            total_today: 142,
            high_risk_count: 5,
            risk_distribution: { 'ê³ ìœ„í—˜': 5, 'ì¤‘ìœ„í—˜': 12, 'ì €ìœ„í—˜': 125 }
        };

        const MOCK_JOBS = [
            { id: 1, title: "[Sample] Backend Developer", company: "Tech Corp", crawled_date: "2023-12-08", source_site: "saramin", risk_analysis: { risk_level: "ê³ ìœ„í—˜" }, url: "#" },
            { id: 2, title: "[Sample] Frontend Engineer", company: "Creative Inc", crawled_date: "2023-12-08", source_site: "jobkorea", risk_analysis: { risk_level: "ì¤‘ìœ„í—˜" }, url: "#" },
            { id: 3, title: "[Sample] Data Scientist", company: "AI Lab", crawled_date: "2023-12-08", source_site: "worknet", risk_analysis: { risk_level: "ì €ìœ„í—˜" }, url: "#" },
        ];

        function MetricCard({ title, value, color, icon }) {
            return (
                <div className="glass-card flex items-center gap-4">
                    <div className={`p-4 rounded-full bg-opacity-20`} style={{ backgroundColor: color + '33', color: color }}>
                        <span className="text-2xl font-bold">{icon}</span>
                    </div>
                    <div>
                        <div className="text-slate-400 text-sm">{title}</div>
                        <div className="text-2xl font-bold">{value}</div>
                    </div>
                </div>
            );
        }

        function Dashboard() {
            const [view, setView] = useState('dashboard');
            const [stats, setStats] = useState(MOCK_STATS); // Initialize with Mock
            const [jobs, setJobs] = useState(MOCK_JOBS);   // Initialize with Mock
            const [loading, setLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState('Checking...');

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const statsRes = await axios.get(`${API_BASE}/dashboard/stats`);
                    setStats(statsRes.data);

                    const jobsRes = await axios.get(`${API_BASE}/jobs`);
                    setJobs(jobsRes.data);

                    setApiStatus('Online (Connected to Backend)');
                } catch (err) {
                    console.error("API Error - Using Mock Data", err);
                    setApiStatus('Offline (Using Mock Data - Check Backend)');
                }
            };

            const runCrawler = async () => {
                if (!confirm("Start crawling all sites?")) return;
                setLoading(true);
                try {
                    await axios.post(`${API_BASE}/crawlers/crawl`, { site: 'all', max_jobs: 10 });
                    alert("Crawler started in background!");
                } catch (e) {
                    alert("Failed to start crawler (Backend might be disconnected)");
                }
                setLoading(false);
            };

            const chartData = {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [
                        stats.risk_distribution['ê³ ìœ„í—˜'] || 0,
                        stats.risk_distribution['ì¤‘ìœ„í—˜'] || 0,
                        stats.risk_distribution['ì €ìœ„í—˜'] || 0
                    ],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                    borderWidth: 0
                }]
            };

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <div className="w-64 border-r border-slate-800 p-8 flex flex-col gap-6">
                        <h1 className="text-2xl font-bold gradient-text mb-4">Recruit<br />Guardian</h1>
                        <button onClick={() => setView('dashboard')} className={`text-left p-3 rounded hover:bg-slate-800 transition ${view === 'dashboard' ? 'bg-slate-800 text-blue-400' : ''}`}>
                            ðŸ“Š Dashboard
                        </button>
                        <button onClick={() => setView('jobs')} className={`text-left p-3 rounded hover:bg-slate-800 transition ${view === 'jobs' ? 'bg-slate-800 text-blue-400' : ''}`}>
                            ðŸ“‹ Job Monitor
                        </button>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-8 overflow-auto">
                        <div className="mb-4 text-xs text-slate-500 text-right">
                            System Status: <span className={apiStatus.includes('Online') ? 'text-green-500' : 'text-amber-500'}>{apiStatus}</span>
                        </div>

                        {view === 'dashboard' && (
                            <div className="space-y-8">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-3xl font-bold">Dashboard</h2>
                                    <button onClick={runCrawler} disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition cursor-pointer disabled:opacity-50">
                                        {loading ? 'Starting...' : 'ðŸš€ Start Crawling'}
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <MetricCard title="Today's Jobs" value={stats.total_today} color="#3b82f6" icon="ðŸ”" />
                                    <MetricCard title="High Risk" value={stats.high_risk_count} color="#ef4444" icon="âš ï¸" />
                                    <MetricCard title="Services" value="Active" color="#10b981" icon="âœ…" />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="glass-card h-80">
                                        <h3 className="text-xl font-bold mb-4">Risk Distribution</h3>
                                        <div className="h-full flex justify-center pb-8">
                                            <Doughnut data={chartData} options={{ maintainAspectRatio: false }} />
                                        </div>
                                    </div>
                                    <div className="glass-card">
                                        <h3 className="text-xl font-bold mb-4">Recent Alerts</h3>
                                        <div className="space-y-4">
                                            {jobs.filter(j => j.risk_analysis?.risk_level === 'ê³ ìœ„í—˜').slice(0, 3).map(job => (
                                                <div key={job.id} className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                                                    <div className="font-bold text-red-400">ðŸš¨ High Risk Detected</div>
                                                    <div className="text-sm mt-1">{job.title}</div>
                                                    <div className="text-xs text-slate-400 mt-1">{job.company}</div>
                                                </div>
                                            ))}
                                            {jobs.filter(j => j.risk_analysis?.risk_level === 'ê³ ìœ„í—˜').length === 0 && (
                                                <div className="text-slate-500 text-center py-8">No high risk alerts today.</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'jobs' && (
                            <div className="space-y-6">
                                <h2 className="text-3xl font-bold">Job Monitor</h2>
                                <div className="glass-card overflow-hidden p-0">
                                    <table className="w-full text-left border-collapse table-auto">
                                        <thead className="bg-slate-800/50">
                                            <tr>
                                                <th className="p-4">Risk</th>
                                                <th className="p-4">Title</th>
                                                <th className="p-4">Company</th>
                                                <th className="p-4">Date</th>
                                                <th className="p-4">Site</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {jobs.map(job => {
                                                const risk = job.risk_analysis?.risk_level || 'ì €ìœ„í—˜';
                                                let badgeClass = 'bg-green-500/10 text-green-500 border-green-500/20';
                                                if (risk === 'ê³ ìœ„í—˜') badgeClass = 'bg-red-500/10 text-red-500 border-red-500/20';
                                                if (risk === 'ì¤‘ìœ„í—˜') badgeClass = 'bg-amber-500/10 text-amber-500 border-amber-500/20';

                                                return (
                                                    <tr key={job.id} className="border-b border-slate-700/50 hover:bg-slate-800/30">
                                                        <td className="p-4">
                                                            <span className={`px-2 py-1 rounded-full text-xs border ${badgeClass}`}>
                                                                {risk}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 font-medium">
                                                            <a href={job.url} target="_blank" className="hover:text-blue-400 block truncate max-w-md">
                                                                {job.title}
                                                            </a>
                                                        </td>
                                                        <td className="p-4 text-slate-400">{job.company}</td>
                                                        <td className="p-4 text-slate-400 text-sm">{job.crawled_date}</td>
                                                        <td className="p-4 text-sm">{job.source_site}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>

</html>